<html>
  <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    
  </head>

  <body>

    <form>
      Currency: <br>
      <input type="radio" name="currencyName" value="USD" checked="checked" >USD
      <input type="radio" name="currencyName" value="HKD" >HKD
      <input type="radio" name="currencyName" value="GBP" >GBP
      <input type="radio" name="currencyName" value="AUD" >AUD
      <input type="radio" name="currencyName" value="CAD" >CAD
      <input type="radio" name="currencyName" value="SGD" >SGD
      <input type="radio" name="currencyName" value="CHF" >CHF
      <input type="radio" name="currencyName" value="JPY" >JPY <br>
      <input type="radio" name="currencyName" value="ZAR" >ZAR
      <input type="radio" name="currencyName" value="SEK" >SEK
      <input type="radio" name="currencyName" value="NZD" >NZD
      <input type="radio" name="currencyName" value="THB" >THB
      <input type="radio" name="currencyName" value="PHP" >PHP
      <input type="radio" name="currencyName" value="IDR" >IDR
      <input type="radio" name="currencyName" value="EUR" >EUR
      <input type="radio" name="currencyName" value="MYR" >MYR
      <input type="radio" name="currencyName" value="KRW" >KRW
    </form>
    <form>
      <input type="checkbox" name="cachspot" value="Cash"> Cash
      <input type="checkbox" name="cachspot" value="Spot" checked> Spot
    </form>
    <form>
      Period: <br>
      <input type="radio" name="period" value='7' >Week
      <input type="radio" name="period" value='30' checked="checked">Month      
      <input type="radio" name="period" value='120'>Season      
      <input type="radio" name="period" value='180'>Half Year      
      <input type="radio" name="period" value='365'>Year
      <input type="radio" name="period" value='1460'>4 Years
      <input type="radio" name="period" value='3650'>Decade
      <!-- TBD -->
      <!-- <input type="radio" name="period" >History -->
    </form>

    <script type="text/javascript">
    
    var temp = $("[name=currencyName]:checked").val();

    var currName='USD';
    var queryDays =30;
    var cashSpot='Spot';
    var rate='Buying';
    var buyingMid=0, sellingMid=0;


      $("input[type=radio][name=currencyName]").on("change",function(){
        currName=$("[name=currencyName]:checked").val(); 
        getMid(queryDays);       
            google.charts.load('current', {'packages':['line']});
            google.charts.setOnLoadCallback(drawChart);

      });
      $("input[type=radio][name=period]").on("change",function(){        
        queryDays=$("[name=period]:checked").val();
        getMid(queryDays);
            google.charts.load('current', {'packages':['line']});
            google.charts.setOnLoadCallback(drawChart);
      });

    getMid(queryDays);
    google.charts.load('current', {'packages':['line']});
    google.charts.setOnLoadCallback(drawChart);
    
    function getMid(in_days){
      var historyDatas = $.ajax({
            url: "http://localhost:8080/simonExp/currency/CurrencyResource/fetchHistory?CurrencyName="+currName,
            dataType: "json",
            async: false
          }).responseJSON;  

      var buyingSpotHistory, sellingSpotHistory;

      for (var data in historyDatas) {
        if (historyDatas[data].rate == 'Buying' && historyDatas[data].cashspot == cashSpot) {
          buyingSpotHistory=historyDatas[data];          
        }        
        if (historyDatas[data].rate == 'Selling' && historyDatas[data].cashspot == cashSpot) {
          sellingSpotHistory=historyDatas[data];          
        }     
      }

      switch(String(in_days)){
        case '7':
          buyingMid=(buyingSpotHistory.weekHigh+buyingSpotHistory.weekLow)/2;
          sellingMid=(sellingSpotHistory.weekHigh+sellingSpotHistory.weekLow)/2;
          break;
        case '30':
          buyingMid=(buyingSpotHistory.monthHigh+buyingSpotHistory.monthLow)/2;
          sellingMid=(sellingSpotHistory.monthHigh+sellingSpotHistory.monthLow)/2;
          break;  
        case '120':
          buyingMid=(buyingSpotHistory.seasonHigh+buyingSpotHistory.seasonLow)/2;
          sellingMid=(sellingSpotHistory.seasonHigh+sellingSpotHistory.seasonLow)/2;
          break;  
        case '180':
          buyingMid=(buyingSpotHistory.halfYearHigh+buyingSpotHistory.halfYearLow)/2;
          sellingMid=(sellingSpotHistory.halfYearHigh+sellingSpotHistory.halfYearLow)/2;
          break;  
        case '365':
          buyingMid=(buyingSpotHistory.yearHigh+buyingSpotHistory.yearLow)/2;
          sellingMid=(sellingSpotHistory.yearHigh+sellingSpotHistory.yearLow)/2;
          break;  
        case '1460':
          buyingMid=(buyingSpotHistory.fourYearHigh+buyingSpotHistory.fourYearLow)/2;
          sellingMid=(sellingSpotHistory.fourYearHigh+sellingSpotHistory.fourYearLow)/2;
          break;  
        case '3650':
          buyingMid=(buyingSpotHistory.decadeHigh+buyingSpotHistory.decadeLow)/2;
          sellingMid=(sellingSpotHistory.decadeHigh+sellingSpotHistory.decadeLow)/2;
          break;
        default :
          buyingMid=0;
          sellingMid=0;
          break;
      }
    }


    function drawChart() {
      var dateAnchor = Date.now(); 
      var yesterday = new Date(dateAnchor - 1000 * 60 * 60 * 24 );
      var AboveDays = new Date(dateAnchor - 1000 * 60 * 60 * 24 * queryDays);
      var endDate = String(yesterday.getFullYear()).concat('-',String(yesterday.getMonth()+1),'-',String(yesterday.getDate()));
      var startDate = String(AboveDays.getFullYear()).concat('-',String(AboveDays.getMonth()+1),'-',String(AboveDays.getDate()));
    
      var buyingData = $.ajax({
            url: "http://localhost:8080/simonExp/currency/CurrencyResource?CurrencyName="+currName+"&Rate=Buying&CashSpot=Spot&StartDate="+startDate+"&EndDate="+endDate,
            dataType: "json",
            async: false
          }).responseJSON;   

      var sellingData = $.ajax({
            url: "http://localhost:8080/simonExp/currency/CurrencyResource?CurrencyName="+currName+"&Rate=Selling&CashSpot=Spot&StartDate="+startDate+"&EndDate="+endDate,
            dataType: "json",
            async: false
          }).responseJSON;   


      var data = new google.visualization.DataTable();

      data.addColumn('date', 'Date');
      data.addColumn('number', 'Buying - Mid');
      data.addColumn('number', 'Selling - Mid');     
      data.addColumn('number', 'Buying');
      data.addColumn('number', 'Selling');
 
      var dataSet = [];

      for (var i = 0; i < buyingData.length; i++) {
        dataSet.push([new Date(buyingData[i].rateDate), buyingMid, sellingMid, buyingData[i].price, sellingData[i].price ]);
      }

      data.addRows(dataSet);
          
      var options = {
        // chart: {
        //   title: 'Box Office Earnings in First Two Weeks of Opening',
        //   subtitle: 'in millions of dollars (USD)'
        // },
        width: 900,
        height: 500,
        vAxis: { gridlines: { count: 4 } ,
                  format: 'decimal'
                },
        series: {
                  0: {color: '#B0B0B0', visibleInLegend: false, lineDashStyle: [20, 20, 10, 10] },
                  1: {color: '#B0B0B0', visibleInLegend: false, lineDashStyle: [20, 20] },
                  2: {color: 'green', visibleInLegend: true },
                  3: {color: 'red', visibleInLegend: true }
                }        
      };

      var chart = new google.charts.Line(document.getElementById('linechart_material'));

      chart.draw(data, google.charts.Line.convertOptions(options));
    }



    function syncHistory(){

      var syncResp = $.ajax({
                        type: "POST",
                        url: "http://localhost:8080/simonExp/currency/CurrencyResource/updateTilToday",
                        dataType: "json",
                        async: false
                      });

      var currName = document.getElementsByName('currencyName').value;
      var dateAnchor = new Date(Date.now()); 
      var dateParam = String(dateAnchor.getFullYear()).concat('-',String(dateAnchor.getMonth()+1),'-',String(dateAnchor.getDate()));

      $.ajax({
        type: "POST",
        url: "http://localhost:8080/simonExp/currency/CurrencyResource/updateAllHistory?BaseDate="+dateParam,
        dataType: "json",
        async: false
      });      
    }

    </script>
    <!--Div that will hold the pie chart-->
    <div id="linechart_material"></div>

    <button onclick="syncHistory()">Sync History</button>
    <p id="syncResult"></p>
    

  </body>
</html>
