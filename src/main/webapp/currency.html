<html>
  <head>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    
  </head>

  <body>

    <form>
      Currency: <br>
      <input type="radio" name="currencyName" value="USD" checked="checked" >USD
      <input type="radio" name="currencyName" value="HKD" >HKD
      <input type="radio" name="currencyName" value="GBP" >GBP
      <input type="radio" name="currencyName" value="AUD" >AUD
      <input type="radio" name="currencyName" value="CAD" >CAD
      <input type="radio" name="currencyName" value="SGD" >SGD
      <input type="radio" name="currencyName" value="CHF" >CHF
      <input type="radio" name="currencyName" value="JPY" >JPY <br>
      <input type="radio" name="currencyName" value="ZAR" >ZAR
      <input type="radio" name="currencyName" value="SEK" >SEK
      <input type="radio" name="currencyName" value="NZD" >NZD
      <input type="radio" name="currencyName" value="THB" >THB
      <input type="radio" name="currencyName" value="PHP" >PHP
      <input type="radio" name="currencyName" value="IDR" >IDR
      <input type="radio" name="currencyName" value="EUR" >EUR
      <input type="radio" name="currencyName" value="MYR" >MYR
      <input type="radio" name="currencyName" value="KRW" >KRW
    </form>
    <form>
      <input type="checkbox" name="cachspot" value="Cash"> Cash
      <input type="checkbox" name="cachspot" value="Spot" checked> Spot
    </form>
    <form>
      Period: <br>
      <input type="radio" name="period" value='7' >Week
      <input type="radio" name="period" value='30' checked="checked">Month      
      <input type="radio" name="period" value='120'>Season      
      <input type="radio" name="period" value='180'>Half Year      
      <input type="radio" name="period" value='365'>Year
      <input type="radio" name="period" value='1460'>4 Years
      <input type="radio" name="period" value='3650'>Decade
      <!-- TBD -->
      <!-- <input type="radio" name="period" >History -->
    </form>
    <form>
      Statics <br>
      <input type="checkbox" name="statics" value="Mean" checked > Mean
      <input type="checkbox" name="statics" value="Variance" checked> Variance
      <input type="checkbox" name="statics" value="Standard Derivation" > Standard Deviation      
    </form>

    <script type="text/javascript">

    var paramMap = {};
    paramMap['currencyName']='USD';
    paramMap['period']=30;
    paramMap['showBuying']=true;
    paramMap['showSelling']=true;
    paramMap['showMean']=false;
    paramMap['showVariance']=false;
    paramMap['showStandardDeviation']=true;


    
    var temp = $("[name=currencyName]:checked").val();
    var temp2 = $("[name=statics]:checked");

    var currName='USD';
    var queryDays =30;
    var cashSpot='Spot';
    var rate='Buying';
    var buyingMid=0, sellingMid=0;


    $("input[type=radio][name=currencyName]").on("change",function(){
          currName=$("[name=currencyName]:checked").val(); 
          google.charts.load('current', {'packages':['line']});
          google.charts.setOnLoadCallback(drawChart);

    });
    $("input[type=radio][name=period]").on("change",function(){        
          queryDays=$("[name=period]:checked").val();
          google.charts.load('current', {'packages':['line']});
          google.charts.setOnLoadCallback(drawChart);
    });

    google.charts.load('current', {'packages':['line']});
    google.charts.setOnLoadCallback(drawChart);
    


    // function getMid(in_days){
    //   var historyDatas = $.ajax({
    //         url: "http://localhost:8080/simonExp/currency/CurrencyResource/fetchHistory?CurrencyName="+currName,
    //         dataType: "json",
    //         async: false
    //       }).responseJSON;  

    //   var buyingSpotHistory, sellingSpotHistory;

    //   for (var data in historyDatas) {
    //     if (historyDatas[data].rate == 'Buying' && historyDatas[data].cashspot == cashSpot) {
    //       buyingSpotHistory=historyDatas[data];          
    //     }        
    //     if (historyDatas[data].rate == 'Selling' && historyDatas[data].cashspot == cashSpot) {
    //       sellingSpotHistory=historyDatas[data];          
    //     }     
    //   }

    //   switch(String(in_days)){
    //     case '7':
    //       buyingMid=(buyingSpotHistory.weekHigh+buyingSpotHistory.weekLow)/2;
    //       sellingMid=(sellingSpotHistory.weekHigh+sellingSpotHistory.weekLow)/2;
    //       break;
    //     case '30':
    //       buyingMid=(buyingSpotHistory.monthHigh+buyingSpotHistory.monthLow)/2;
    //       sellingMid=(sellingSpotHistory.monthHigh+sellingSpotHistory.monthLow)/2;
    //       break;  
    //     case '120':
    //       buyingMid=(buyingSpotHistory.seasonHigh+buyingSpotHistory.seasonLow)/2;
    //       sellingMid=(sellingSpotHistory.seasonHigh+sellingSpotHistory.seasonLow)/2;
    //       break;  
    //     case '180':
    //       buyingMid=(buyingSpotHistory.halfYearHigh+buyingSpotHistory.halfYearLow)/2;
    //       sellingMid=(sellingSpotHistory.halfYearHigh+sellingSpotHistory.halfYearLow)/2;
    //       break;  
    //     case '365':
    //       buyingMid=(buyingSpotHistory.yearHigh+buyingSpotHistory.yearLow)/2;
    //       sellingMid=(sellingSpotHistory.yearHigh+sellingSpotHistory.yearLow)/2;
    //       break;  
    //     case '1460':
    //       buyingMid=(buyingSpotHistory.fourYearHigh+buyingSpotHistory.fourYearLow)/2;
    //       sellingMid=(sellingSpotHistory.fourYearHigh+sellingSpotHistory.fourYearLow)/2;
    //       break;  
    //     case '3650':
    //       buyingMid=(buyingSpotHistory.decadeHigh+buyingSpotHistory.decadeLow)/2;
    //       sellingMid=(sellingSpotHistory.decadeHigh+sellingSpotHistory.decadeLow)/2;
    //       break;
    //     default :
    //       buyingMid=0;
    //       sellingMid=0;
    //       break;
    //   }
    // }


    function drawChart() {
      var dateAnchor = Date.now(); 
      var yesterday = new Date(dateAnchor - 1000 * 60 * 60 * 24 );
      var AboveDays = new Date(dateAnchor - 1000 * 60 * 60 * 24 * queryDays);
      var endDate = String(yesterday.getFullYear()).concat('-',String(yesterday.getMonth()+1),'-',String(yesterday.getDate()));
      var startDate = String(AboveDays.getFullYear()).concat('-',String(AboveDays.getMonth()+1),'-',String(AboveDays.getDate()));

      console.log("date from "+startDate+" to "+endDate);

      var buyingData = $.ajax({
            url: "http://localhost:8080/simonExp/currency/CurrencyResource?CurrencyName="+currName+"&Rate=Buying&CashSpot=Spot&StartDate="+startDate+"&EndDate="+endDate,
            dataType: "json",
            async: false
          }).responseJSON;   

      var sellingData = $.ajax({
            url: "http://localhost:8080/simonExp/currency/CurrencyResource?CurrencyName="+currName+"&Rate=Selling&CashSpot=Spot&StartDate="+startDate+"&EndDate="+endDate,
            dataType: "json",
            async: false
          }).responseJSON;   


      var buyingStatic = getStaticResult(buyingData.map(function(res){
                    return res.price;
                  }));
      var sellingStatic = getStaticResult(sellingData.map(function(res){
                    return res.price;
                  }));

      var data = new google.visualization.DataTable();

      data.addColumn('date', 'Date');   

      if (paramMap['showBuying'] && paramMap['showStandardDeviation']) {
        data.addColumn('number', 'Buying Upper SD');   
        // data.addColumn('number', 'Buying Lower SD');   
      }
      if (paramMap['showSelling'] && paramMap['showStandardDeviation']) {
        // data.addColumn('number', 'Selling Upper SD');   
        data.addColumn('number', 'Selling Lower SD');   
      }

      data.addColumn('number', 'Buying');
      data.addColumn('number', 'Selling');
 
      var dataSet = [];

      for (var i = 0; i < buyingData.length; i++) {
        var eachData=[new Date(buyingData[i].rateDate), buyingData[i].price, sellingData[i].price];
        var price=eachData[1];

        if (paramMap['showBuying'] && paramMap['showStandardDeviation']) {
          eachData.splice(1,0, buyingStatic.ArithMean + buyingStatic.StandardDeviation);
          // eachData.splice(2,0, buyingStatic.ArithMean - buyingStatic.StandardDeviation);
        }
        if (paramMap['showSelling'] && paramMap['showStandardDeviation']) {
          // eachData.splice(1,0, sellingStatic.ArithMean + buyingStatic.StandardDeviation);
          eachData.splice(2,0, sellingStatic.ArithMean - buyingStatic.StandardDeviation);
        }
        dataSet.push(eachData);
      }

      console.log("Buying ArithMean: "+buyingStatic.ArithMean);
      console.log("Buying Standard Deviation: "+buyingStatic.StandardDeviation);
      console.log("Selling ArithMean: "+sellingStatic.ArithMean);
      console.log("Selling Standard Deviation: "+sellingStatic.StandardDeviation);


      data.addRows(dataSet);
          
      var options = {
        // chart: {
        //   title: 'Box Office Earnings in First Two Weeks of Opening',
        //   subtitle: 'in millions of dollars (USD)'
        // },
        width: 900,
        height: 500,
        vAxis: { gridlines: { count: 4 } ,
                  format: 'decimal'
                },
        series: {

                  // 0: {color: 'green', visibleInLegend: true },
                  // 1: {color: 'red', visibleInLegend: true }
                }        
      };

      var chart = new google.charts.Line(document.getElementById('linechart_material'));

      chart.draw(data, google.charts.Line.convertOptions(options));
    }



    function syncHistory(){

      var syncResp = $.ajax({
                        type: "POST",
                        url: "http://localhost:8080/simonExp/currency/CurrencyResource/updateTilToday",
                        dataType: "json",
                        async: false
                      });

      var currName = document.getElementsByName('currencyName').value;
      var dateAnchor = new Date(Date.now()); 
      var dateParam = String(dateAnchor.getFullYear()).concat('-',String(dateAnchor.getMonth()+1),'-',String(dateAnchor.getDate()));

      $.ajax({
        type: "POST",
        url: "http://localhost:8080/simonExp/currency/CurrencyResource/updateAllHistory?BaseDate="+dateParam,
        dataType: "json",
        async: false
      });      
    }

    function getStaticResult(DoubleArrays){            
      return staticsResult = $.ajax({
                                type: "POST",
                                url: "http://localhost:8080/simonExp/currency/StrategyResource",
                                contentType: 'application/json',
                                data: JSON.stringify(DoubleArrays),
                                async: false
                              }).responseJSON;      
      console.log(staticsResult);
    }
    </script>
    <!--Div that will hold the pie chart-->
    <div id="linechart_material"></div>

    <button onclick="syncHistory()">Sync History</button>
    <p id="syncResult"></p>
    
    
  </body>
</html>
